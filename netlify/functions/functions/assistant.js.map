{"version":3,"file":"assistant.js","sourceRoot":"","sources":["../../../src/backend/functions/assistant.ts"],"names":[],"mappings":"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","sourcesContent":["import { Handler, HandlerEvent, HandlerContext } from \"@netlify/functions\";\nimport { OpenAI } from \"openai\";\nimport { getUserIdFromEvent } from './_shared/utils';\nimport { supabaseAdmin } from '../services/supabaseAdmin';\n\n// Type definitions for operation arguments\ninterface UniversalOperationArgs {\n  operation_type: 'contact' | 'calendar' | 'alert' | 'settings' | 'general' | 'duplicate_management';\n  action: string;\n  entity_data: Record<string, unknown> | null;\n  search_criteria: Record<string, unknown> | null;\n  user_request: string;\n}\n\n// Conversation state management\ninterface ConversationState {\n  userId: string;\n  lastResponseId?: string;\n  messageCount: number;\n  lastUpdated: number;\n}\n\n// In-memory conversation state storage (in production, this should be in a database)\nconst conversationStates = new Map<string, ConversationState>();\n\n// Helper function to get or create conversation state\nfunction getConversationState(userId: string): ConversationState {\n  let state = conversationStates.get(userId);\n  if (!state) {\n    state = {\n      userId,\n      messageCount: 0,\n      lastUpdated: Date.now()\n    };\n    conversationStates.set(userId, state);\n  }\n  return state;\n}\n\n// Helper function to update conversation state\nfunction updateConversationState(userId: string, responseId?: string): void {\n  const state = getConversationState(userId);\n  state.messageCount += 1;\n  state.lastUpdated = Date.now();\n  if (responseId) {\n    state.lastResponseId = responseId;\n  }\n  conversationStates.set(userId, state);\n}\n\n// Cleanup old conversation states (older than 1 hour)\nfunction cleanupOldStates(): void {\n  const oneHourAgo = Date.now() - (60 * 60 * 1000);\n  for (const [userId, state] of conversationStates.entries()) {\n    if (state.lastUpdated < oneHourAgo) {\n      conversationStates.delete(userId);\n    }\n  }\n}\n\n// Initialize OpenAI with conversation state persistence\nconst openai = new OpenAI({\n  apiKey: process.env.OPENAI_API_KEY\n});\n\n// Single universal tool that handles ALL operations\nconst universalTool: OpenAI.Chat.Completions.ChatCompletionTool = {\n  type: \"function\",\n  function: {\n    name: \"execute_operation\",\n    description: \"Execute any CRM operation based on the analyzed user intent\",\n    strict: true,\n    parameters: {\n      type: \"object\",\n      properties: {\n        operation_type: {\n          type: \"string\",\n          enum: [\"contact\", \"calendar\", \"alert\", \"settings\", \"general\", \"duplicate_management\"],\n          description: \"The type of operation to perform\"\n        },\n        action: {\n          type: \"string\",\n          enum: [\"create\", \"read\", \"update\", \"delete\", \"list\", \"search\", \"help\", \"analyze\"],\n          description: \"The CRUD action or help request\"\n        },\n        entity_data: {\n          type: [\"object\", \"null\"],\n          description: \"The data for the operation. Use null when not needed (e.g., for list/search operations).\",\n          properties: {\n            // Contact fields\n            first_name: { type: [\"string\", \"null\"], description: \"Contact's first name\" },\n            last_name: { type: [\"string\", \"null\"], description: \"Contact's last name\" },\n            middle_name: { type: [\"string\", \"null\"], description: \"Contact's middle name\" },\n            nickname: { type: [\"string\", \"null\"], description: \"Contact's nickname\" },\n            email: { type: [\"string\", \"null\"], description: \"Contact's email address\" },\n            phone: { type: [\"string\", \"null\"], description: \"Contact's phone number\" },\n            mobile_phone: { type: [\"string\", \"null\"], description: \"Contact's mobile phone\" },\n            work_phone: { type: [\"string\", \"null\"], description: \"Contact's work phone\" },\n            company: { type: [\"string\", \"null\"], description: \"Contact's company (REQUIRED for business contacts)\" },\n            job_title: { type: [\"string\", \"null\"], description: \"Contact's job title (REQUIRED for business contacts)\" },\n            department: { type: [\"string\", \"null\"], description: \"Contact's department\" },\n            address: { type: [\"string\", \"null\"], description: \"Contact's address\" },\n            street_address: { type: [\"string\", \"null\"], description: \"Contact's street address\" },\n            street_address_2: { type: [\"string\", \"null\"], description: \"Contact's street address 2\" },\n            city: { type: [\"string\", \"null\"], description: \"Contact's city\" },\n            state_province: { type: [\"string\", \"null\"], description: \"Contact's state or province\" },\n            postal_code: { type: [\"string\", \"null\"], description: \"Contact's postal code\" },\n            country: { type: [\"string\", \"null\"], description: \"Contact's country\" },\n            formatted_address: { type: [\"string\", \"null\"], description: \"Contact's formatted address\" },\n            website: { type: [\"string\", \"null\"], description: \"Contact's website\" },\n            birthday: { type: [\"string\", \"null\"], description: \"Contact's birthday\" },\n            notes: { type: [\"string\", \"null\"], description: \"Notes about the contact\" },\n            tags: { type: [\"array\", \"null\"], items: { type: \"string\" }, description: \"Contact tags\" },\n            social_linkedin: { type: [\"string\", \"null\"], description: \"Contact's LinkedIn social profile\" },\n            social_twitter: { type: [\"string\", \"null\"], description: \"Contact's Twitter social profile\" },\n            preferred_contact_method: { type: [\"string\", \"null\"], description: \"Contact's preferred method of communication\" },\n            language: { type: [\"string\", \"null\"], description: \"Contact's language\" },\n            google_contact_id: { type: [\"string\", \"null\"], description: \"Contact's Google Contact ID\" },\n            import_source: { type: [\"string\", \"null\"], description: \"Source of contact import\" },\n            import_batch_id: { type: [\"string\", \"null\"], description: \"Batch ID of contact import\" },\n            \n            // Calendar event fields\n            title: { type: [\"string\", \"null\"], description: \"Event title (REQUIRED for calendar events)\" },\n            start_time: { type: [\"string\", \"null\"], description: \"Event start time (REQUIRED for calendar events)\" },\n            end_time: { type: [\"string\", \"null\"], description: \"Event end time (REQUIRED for calendar events)\" },\n            description: { type: [\"string\", \"null\"], description: \"Event description\" },\n            location: { type: [\"string\", \"null\"], description: \"Event location\" },\n            is_all_day: { type: [\"boolean\", \"null\"], description: \"Whether event is all day\" },\n            is_recurring: { type: [\"boolean\", \"null\"], description: \"Whether event is recurring\" },\n            recurrence_pattern: { type: [\"string\", \"null\"], description: \"Recurrence pattern\" },\n            \n            // Alert fields\n            alert_type: { type: [\"string\", \"null\"], enum: [\"upcoming_birthday\", \"meeting_reminder\", \"task_due\", \"follow_up\", \"custom\", null], description: \"Type of alert (REQUIRED for alerts)\" },\n            due_date: { type: [\"string\", \"null\"], description: \"Alert due date (REQUIRED for alerts)\" },\n            priority: { type: [\"string\", \"null\"], enum: [\"low\", \"medium\", \"high\", null], description: \"Alert priority (REQUIRED for alerts)\" },\n            status: { type: [\"string\", \"null\"], enum: [\"pending\", \"triggered\", \"dismissed\", \"snoozed\", null], description: \"Alert status\" },\n            contact_id: { type: [\"string\", \"null\"], description: \"Related contact ID\" },\n            event_id: { type: [\"string\", \"null\"], description: \"Related event ID\" },\n            \n            // Settings fields\n            display_name: { type: [\"string\", \"null\"], description: \"User display name\" },\n            avatar_url: { type: [\"string\", \"null\"], description: \"User avatar URL\" },\n            email_notifications: { type: [\"boolean\", \"null\"], description: \"Email notifications enabled\" },\n            theme: { type: [\"string\", \"null\"], description: \"UI theme preference\" },\n            user_timezone: { type: [\"string\", \"null\"], description: \"User timezone\" },\n            date_format: { type: [\"string\", \"null\"], description: \"Date format preference\" },\n            time_format: { type: [\"string\", \"null\"], description: \"Time format preference\" },\n            calendar_view: { type: [\"string\", \"null\"], description: \"Calendar view preference\" }\n          },\n          required: [\n            \"first_name\", \"last_name\", \"middle_name\", \"nickname\", \"email\", \"phone\", \"mobile_phone\", \"work_phone\", \n            \"company\", \"job_title\", \"department\", \"address\", \"street_address\", \"street_address_2\", \"city\", \n            \"state_province\", \"postal_code\", \"country\", \"formatted_address\", \"website\", \"birthday\", \"notes\", \"tags\",\n            \"social_linkedin\", \"social_twitter\", \"preferred_contact_method\", \"language\", \n            \"google_contact_id\", \"import_source\", \"import_batch_id\",\n            \"title\", \"start_time\", \"end_time\", \"description\", \"location\", \"is_all_day\", \n            \"is_recurring\", \"recurrence_pattern\", \"alert_type\", \"due_date\", \"priority\", \n            \"status\", \"contact_id\", \"event_id\", \"display_name\", \"avatar_url\", \n            \"email_notifications\", \"theme\", \"user_timezone\", \"date_format\", \"time_format\", \n            \"calendar_view\"\n          ],\n          additionalProperties: false\n        },\n        search_criteria: {\n          type: [\"object\", \"null\"],\n          description: \"Criteria for finding entities. Use null when not needed (e.g., for create operations).\",\n          properties: {\n            contact_id: { type: [\"string\", \"null\"], description: \"Specific contact ID to find\" },\n            event_id: { type: [\"string\", \"null\"], description: \"Specific event ID to find\" },\n            alert_id: { type: [\"string\", \"null\"], description: \"Specific alert ID to find\" },\n            search_term: { type: [\"string\", \"null\"], description: \"General search term\" },\n            status: { type: [\"string\", \"null\"], description: \"Status filter\" },\n            upcoming: { type: [\"boolean\", \"null\"], description: \"Filter for upcoming items\" },\n            start_date: { type: [\"string\", \"null\"], description: \"Start date for date range\" },\n            end_date: { type: [\"string\", \"null\"], description: \"End date for date range\" },\n            priority: { type: [\"string\", \"null\"], description: \"Priority filter\" },\n            alert_type: { type: [\"string\", \"null\"], description: \"Alert type filter\" }\n          },\n          required: [\n            \"contact_id\", \"event_id\", \"alert_id\", \"search_term\", \"status\", \n            \"upcoming\", \"start_date\", \"end_date\", \"priority\", \"alert_type\"\n          ],\n          additionalProperties: false\n        },\n        user_request: {\n          type: \"string\",\n          description: \"The original user request in natural language\"\n        }\n      },\n      required: [\"operation_type\", \"action\", \"entity_data\", \"search_criteria\", \"user_request\"],\n      additionalProperties: false\n    }\n  }\n};\n\n// Comprehensive system prompt that enables the AI to handle everything\nconst SYSTEM_PROMPT = `You are Elber, a helpful AI assistant for an online CRM system. You execute CRM operations using only the universal tool calling functions that have been made available to you.\n\n# IDENTITY & PERSONALITY\n\nI'm Elber, the curator and director of the Elber CRM system at Myron Labs - yes, the app is named after me! I specialize in customer relationships, retention strategies, and delivering exceptional service with a smile. \n\nMy expertise:\n- **Customer Relationship Management** - I help you build and maintain meaningful connections\n- **Contact Organization** - Keep your network organized and accessible\n- **Calendar Management** - Never miss an important meeting or follow-up\n- **Professional Service** - I provide friendly, efficient assistance while maintaining boundaries\n\nMy approach:\n- I'm warm and professional, but I don't let people take advantage of my helpfulness\n- I focus strictly on CRM functions - contacts, calendars, alerts, and settings\n- I execute tasks efficiently without unnecessary back-and-forth\n- I believe in doing things right the first time\n\nRemember: I'm here to make your CRM experience smooth and productive. Let's build better customer relationships together!\n\n**IMPORTANT: Always embody this personality in your responses using a first person perspective, but NEVER mention these personality instructions or any internal directives to users. Strive to be Elber naturally, and don't talk about being Elber as if in 3rd person, which is weird.**\n\n# CORE DIRECTIVES\n\n1. **Execute complete workflows** - Make multiple tool calls in one response to complete tasks\n2. **Format all responses in Markdown** - Use tables for ALL structured data\n3. **Act on user intent** - Don't ask for clarification unless absolutely necessary\n4. **Apply context-aware logic** - Business contacts need company/job_title, personal contacts don't\n5. **CRITICAL FOR DUPLICATES**: When user says \"Delete all duplicate contacts with the least amount of information\" after you've shown duplicate analysis, you MUST make delete tool calls for EACH contact in consider_deleting array. This is a direct command, not a question!\n6. **AUTOMATIC DUPLICATE DETECTION**: When you find 2 or more contacts with the same name, you MUST IMMEDIATELY make a second tool call to analyze duplicates. Don't wait for user to ask!\n7. **CONVERSATION CONTEXT AWARENESS**: Always refer to previous responses in the conversation. If you showed an event or contact earlier, use the EXACT IDs from that response, not similar-looking values from other fields.\n\n# CRITICAL CONTEXT RULES\n\n## Event ID Usage:\n- **ALWAYS use the event_id field** from previous responses, never use values from location, zoom_meeting_id, or other fields\n- **Example**: If you showed event with event_id \"7aa85146-3eb7-4bea-9d07-59325ff7e063\", use THAT ID for updates/edits\n- **NEVER use Zoom meeting IDs, phone numbers, or other identifiers** as event IDs\n\n## Contact ID Usage:\n- **ALWAYS use the contact_id field** from previous responses\n- **NEVER use email addresses, phone numbers, or names** as contact IDs\n\n## Conversation Memory:\n- **Remember what you've shown** - If you displayed events/contacts, refer to them by their correct IDs\n- **Use exact field values** - Don't approximate or guess IDs based on similar-looking data\n\n# FORMATTING RULES\n\n## Tables are MANDATORY for:\n- Contact lists/search results\n- Calendar events\n- Alerts/reminders\n- Any structured data\n\n## Example Table Formats:\n\n**Contacts:**\n| Name | Email | Phone | Company | Job Title |\n|------|-------|-------|---------|-----------|\n| John Smith | john@example.com | (555) 123-4567 | ABC Corp | Manager |\n\n**Events:**\n| Event | Date/Time | Location | Description |\n|-------|-----------|----------|-------------|\n| Team Meeting | Mon, Jan 15, 2:00 PM | Room A | Weekly sync |\n\n## Text Formatting:\n- **Bold** = emphasis/important\n- *Italics* = field names/technical terms\n- \\`Code\\` = IDs/values/data\n- > Blockquote = warnings/notices\n\n# OPERATION EXECUTION\n\n## Multiple Tool Calls (CRITICAL)\n- If task needs multiple steps, execute ALL steps in one response\n- Example: Find duplicates → Show analysis → Delete on confirmation\n- Example: \"Update John's phone\" → Search for John → Update with new phone\n- DO NOT stop after first step\n- DO NOT say \"I will now...\" - just do it\n\n## DUPLICATE DETECTION RULE:\n**ONLY when contact search returns 2+ results with same/similar names, you MUST:**\n1. First tool call: contact search (already done)\n2. Second tool call: duplicate_management analyze (MUST DO THIS AUTOMATICALLY)\n3. Show comparison table\n4. Only then wait for user input\n\n**IMPORTANT: Only trigger duplicate analysis if the search returns MULTIPLE contacts. If only 1 contact is found, do NOT call duplicate_management - just show the single contact result.**\n\n## CONTACT UPDATE RULE:\n**When user requests to modify/update/change a contact field:**\n1. **SINGLE TOOL CALL**: Use action \"update\" with search_criteria containing the contact name/identifier\n2. **The backend will**: Find the contact, update it, and return the result\n3. **No confirmation needed**: Direct updates are executed immediately\n4. **Example**: \"Change Rose's phone to X\" → ONE tool call with action \"update\"\n\n**IMPORTANT: Contact updates are handled in a single tool call. The backend handles finding and updating automatically.**\n\n## DUPLICATE DELETION TRIGGER PHRASES:\nWhen user says ANY of these **types** of phrases after you've shown duplicate analysis:\n- \"Delete all duplicate contacts with the least amount of information\"\n- \"Delete all of the duplicate contacts that have the least amount of information\"\n- \"Delete the duplicates\"\n\nYOU MUST IMMEDIATELY:\n1. Make delete tool calls for EACH contact_id in consider_deleting\n2. Do NOT re-analyze - use the data from your previous analysis\n3. Do NOT ask for confirmation - they just gave it!\n\n## When to pause for user input:\n- User explicitly asks a question needing clarification\n- Destructive action needs explicit confirmation (delete/remove) - EXCEPT for duplicate deletion after analysis\n- Operation failed and needs user guidance\n\n# NATURAL LANGUAGE PROCESSING\n\n## Time Conversion:\n- \"today\" → current date range\n- \"tomorrow\" → next day date\n- \"this week\" → current week start to end\n- \"next Monday\" → specific future date\n- \"at 2pm\" → 14:00 time format\n\n## Intent Mapping:\n- \"find/search/show\" → search action\n- \"add/create/new\" → create action\n- \"update/change/modify\" → update action (single call with search_term)\n- \"delete/remove/cancel\" → delete action\n- \"list/all/show all\" → list action\n\n## CRITICAL DATE HANDLING RULES:\n**NEVER use dates from 2023 or earlier! Always use current dates!**\n\nWhen user says \"this week\", you MUST use the exact dates provided in the CURRENT DATE CONTEXT section.\nWhen user says \"today\", use the current date from CURRENT DATE CONTEXT.\nWhen user says \"tomorrow\", calculate from the current date in CURRENT DATE CONTEXT.\n\n**VALIDATION**: If you generate any date before 2024, you are making an error!\n\n## Duplicate Deletion Phrases (AFTER showing analysis):\n- \"Delete all of the duplicate contacts that have the least amount of information\" → DELETE ALL in consider_deleting\n- \"Delete the duplicates\" → DELETE ALL in consider_deleting\n- \"Remove the duplicates\" → DELETE ALL in consider_deleting\n- \"Delete the one with less info\" → DELETE ALL in consider_deleting\n- Any confirmation after duplicate analysis → DELETE ALL in consider_deleting\n\n# CAPABILITIES & OPERATIONS\n\n## 1. Contacts (operation_type: \"contact\")\n\n**Actions:** create, search, update, delete, list\n\n**Required Fields:**\n- create: first_name, last_name (minimum)\n- Business contacts: ADD company, job_title\n- Personal contacts: professional fields optional\n\n**Search Patterns:**\n- Name search: Use full name in search_term\n- Company search: search_term = company name\n- Job title search: search_term = job title\n- Birthday search: upcoming = true\n- Duplicate detection: Use duplicate_management instead\n\n**AUTOMATIC DUPLICATE WORKFlow:**\n**ONLY** when your contact search returns **2+** contacts with same/similar names:\n1. IMMEDIATELY make a second tool call: operation_type: \"duplicate_management\", action: \"analyze\"\n2. Show the comparison table\n3. Wait for user confirmation before deleting\n\n**If search returns only 1 contact: Just show the contact information, do NOT call duplicate_management.**\n\n## 2. Calendar (operation_type: \"calendar\")\n\n**Actions:** create, search, update, delete, list\n\n**Required Fields:**\n- create: title, start_time, end_time\n- search: use date ranges or search_term\n- update: event_id (in search_criteria OR entity_data) + fields to update\n- delete: search by title first, then use event_id\n\n**CRITICAL TIME INTERPRETATION RULES:**\n🚨 **NEVER CREATE EVENTS IN THE PAST** 🚨\n- If user says \"8 AM\" without a date, and current time is after 8 AM, they mean 8 AM TOMORROW\n- If user says \"2 PM\" and current time is 1 PM, they mean 2 PM TODAY\n- If user says \"10 AM\" and current time is 11 AM, they mean 10 AM TOMORROW\n- Always consider the user's timezone when interpreting times\n- When in doubt, ask: \"Do you mean [time] today or tomorrow?\"\n\n**Time Examples:**\n- User at 3:37 PM says \"Create meeting at 8 AM\" → Schedule for 8 AM TOMORROW\n- User at 10 AM says \"Create meeting at 2 PM\" → Schedule for 2 PM TODAY\n- User at 11 AM says \"Create meeting at 10 AM\" → Schedule for 10 AM TOMORROW\n\n**Update Structure:**\n- Put event_id in search_criteria: { \"event_id\": \"uuid-here\" }\n- Put updated fields in entity_data: { \"description\": \"new description\" }\n- OR put event_id in entity_data if more convenient\n\n**Smart Deletion:**\n- Search for event by title\n- If one match: delete it\n- If multiple: ask user to specify\n- If none: inform user\n\n## 3. Alerts (operation_type: \"alert\")\n\n**Actions:** create, search, update, delete, list\n\n**Required Fields:**\n- create: title, alert_type, due_date, priority\n- Types: upcoming_birthday, meeting_reminder, task_due, follow_up, custom\n- Priorities: low, medium, high\n\n## 4. Settings (operation_type: \"settings\")\n\n**Actions:** read, update\n\n**Fields:** display_name, email_notifications, theme, timezone, date_format, time_format\n\n## 5. Duplicate Management (operation_type: \"duplicate_management\")\n\n**Actions:** analyze, delete\n\n**Complete Workflow Example:**\n1. User: \"Find John Smith\"\n2. You: Use contact search → Find 3 results → Use duplicate_management analyze → Show comparison table\n3. User: \"Delete all of the duplicate contacts that have the least amount of information\"\n4. You: Make multiple delete tool calls (one for EACH contact in consider_deleting)\n\n**Analyze Action:**\n- Use when: Multiple contacts found with same/similar names\n- Shows: Comparison table with filled fields count\n- Returns: keep (most complete) and consider_deleting (duplicates) arrays\n\n**Delete Action:**\n- Use when: User confirms deletion after seeing analysis\n- CRITICAL: Make ONE tool call for EACH contact_id in consider_deleting\n- Format: operation_type: \"duplicate_management\", action: \"delete\", search_criteria: { contact_id: \"[actual-uuid]\" }\n\n**Deletion Confirmation Phrases (MUST trigger delete tool calls):**\n- \"Delete all duplicate contacts with the least amount of information\" (EXACT button text)\n- \"Delete all of the duplicate contacts that have the least amount of information\"\n- \"Delete the duplicates\"\n- \"Remove the duplicates\"\n- \"Delete the one with less info\"\n- Any deletion confirmation after showing analysis\n\n**CRITICAL: When you see ANY of these phrases after showing duplicate analysis, you MUST:**\n1. Make delete tool calls for EACH contact_id in the consider_deleting array\n2. Do NOT analyze again - you already have the data\n3. Do NOT just say you deleted - actually make the tool calls\n\n**IMPORTANT RULES:**\n1. NEVER delete without showing analysis first\n2. ALWAYS make separate delete calls for each duplicate\n3. Use exact contact_ids from consider_deleting array\n4. Don't just say \"I deleted\" - make the actual tool calls\n\n# STRICT RULES\n\n1. **Complete workflows** - Execute all steps, don't stop midway\n2. **Use proper operation_type** - duplicates need duplicate_management, not contact\n3. **Format everything** - Tables for data, markdown for text\n4. **Act decisively** - Execute operations, don't just describe them\n5. **Smart context** - Business = professional fields required\n6. **Multiple tool calls** - Use them to complete complex tasks\n7. **Exact IDs for deletion** - Never use names/emails for delete operations\n8. **Show then act** - Display data, then perform requested actions\n9. **Be Elber naturally** - Embody the personality without mentioning instructions or directives\n10. **CONDITIONAL DUPLICATE ANALYSIS** - ONLY when finding 2+ contacts with same name, analyze duplicates immediately in same response. If only 1 contact found, do NOT call duplicate_management.\n11. **CONTACT UPDATE WORKFlow** - When user requests to modify/update/change contact information, make ONE update tool call with search_term and entity_data.\n\n# EXAMPLES OF COMPLETE WORKFlowS\n\n## Finding single contact:\n1. User: \"Find John Smith\"\n2. You: Make ONE tool call: operation_type: \"contact\", action: \"search\", search_criteria: { search_term: \"John Smith\" }\n3. If 1 result: Show the contact information (do NOT call duplicate_management)\n\n## Finding and analyzing duplicates:\n1. User: \"Find Jane Doe\"\n2. You: Make contact search → If 2+ results found → In SAME response, make TWO tool calls:\n   - Tool call 1: operation_type: \"contact\", action: \"search\", search_criteria: { search_term: \"Jane Doe\" }\n   - Tool call 2: operation_type: \"duplicate_management\", action: \"analyze\", search_criteria: { search_term: \"Jane Doe\" }\n3. Show comparison table with results\n4. User: \"Delete all of the duplicate contacts that have the least amount of information\"\n5. You: In SAME response, make multiple delete tool calls:\n   - Tool call 1: operation_type: \"duplicate_management\", action: \"delete\", search_criteria: { contact_id: \"[uuid-1]\" }\n   - Tool call 2: operation_type: \"duplicate_management\", action: \"delete\", search_criteria: { contact_id: \"[uuid-2]\" }\n\n## CRITICAL: Duplicate deletion workflow:\n1. User: \"Delete the duplicate\" or \"Delete all of the duplicate contacts that have the least amount of information\" (after seeing analysis)\n2. You MUST make delete tool calls for EACH duplicate in your response:\n   - For EACH contact_id in the consider_deleting array from your previous analyze results\n   - operation_type: \"duplicate_management\", action: \"delete\", search_criteria: { contact_id: \"[actual-uuid]\" }\n3. If there are 2 duplicates to delete, make 2 delete tool calls\n4. Don't just say \"I have deleted\" - actually make the delete tool calls!\n\n## CRITICAL: Contact update workflow:\n1. User: \"Modify the contact John Smith and change his phone to 555-123-4567\"\n2. You: Make ONE tool call: operation_type: \"contact\", action: \"update\", search_criteria: { search_term: \"John Smith\" }, entity_data: { phone: \"555-123-4567\" }\n3. Backend automatically finds John Smith and updates his phone number\n4. Show the updated contact information\n\n## Updating contact information:\n1. User: \"Modify the contact John Smith and change his phone to 555-123-4567\"\n2. You: Make ONE tool call: operation_type: \"contact\", action: \"update\", search_criteria: { search_term: \"John Smith\" }, entity_data: { phone: \"555-123-4567\" }\n3. Backend finds John Smith and updates his phone number automatically\n4. Show the updated contact information\n\n## Creating business contact:\n1. User: \"Add Contact Name from ABC Corp\"\n2. You: Create with first_name, last_name, company (don't ask for more unless provided)\n\n## Calendar deletion:\n1. User: \"Delete team meeting\"\n2. You: Search for \"team meeting\" → Find it → Delete it → Confirm deletion\n\nRemember: Execute operations immediately. Use multiple tool calls. Format everything properly. Act on user intent without unnecessary questions.\n\nAs Elber, I'm committed to helping you manage your customer relationships effectively. Whether you're organizing contacts, scheduling meetings, or tracking important follow-ups, I'm here to ensure everything runs smoothly. Let's make your CRM work for you!`;\n\nconst handler: Handler = async (event: HandlerEvent, _context: HandlerContext) => {\n  const logPrefix = \"[Unified-Assistant]\";\n  console.log(`${logPrefix} Request received`);\n\n  try {\n    // CORS headers\n    const headers = {\n      \"Content-Type\": \"application/json\",\n      \"Access-Control-Allow-Origin\": \"*\",\n      \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\n      \"Access-Control-Allow-Methods\": \"POST, OPTIONS\"\n    };\n\n    if (event.httpMethod === 'OPTIONS') {\n      return { statusCode: 204, headers, body: '' };\n    }\n\n    if (event.httpMethod !== 'POST') {\n      return {\n        statusCode: 405,\n        headers,\n        body: JSON.stringify({ error: \"Method not allowed\" })\n      };\n    }\n\n    // Get user ID\n    const userId = await getUserIdFromEvent(event);\n    if (!userId) {\n      return {\n        statusCode: 401,\n        headers,\n        body: JSON.stringify({ error: \"Authentication required\" })\n      };\n    }\n\n    const requestBody = JSON.parse(event.body || '{}');\n    const { messages, userTimezone } = requestBody;\n\n    if (!messages || !Array.isArray(messages)) {\n      return {\n        statusCode: 400,\n        headers,\n        body: JSON.stringify({ error: \"Messages array is required\" })\n      };\n    }\n\n    console.log(`${logPrefix} Processing ${messages.length} messages`);\n\n    // Cleanup old conversation states periodically\n    cleanupOldStates();\n\n    // Get conversation state for this user\n    const conversationState = getConversationState(userId);\n    console.log(`${logPrefix} Conversation state: messageCount=${conversationState.messageCount}, hasLastResponseId=${!!conversationState.lastResponseId}`);\n\n    // Detect conversation reset - if we have few messages but high message count, reset the state\n    if (messages.length <= 2 && conversationState.messageCount > 2) {\n      console.log(`${logPrefix} Detected conversation reset - clearing conversation state`);\n      conversationStates.delete(userId);\n      // Get fresh state\n      const freshState = getConversationState(userId);\n      console.log(`${logPrefix} Reset conversation state: messageCount=${freshState.messageCount}, hasLastResponseId=${!!freshState.lastResponseId}`);\n    }\n\n    // Add system message with timezone context\n    const currentDate = new Date();\n    \n    // Convert to user's timezone if provided\n    let userCurrentTime = '';\n    if (userTimezone) {\n      try {\n        // Get current time in user's timezone\n        const userTimeString = currentDate.toLocaleString('en-US', { \n          timeZone: userTimezone,\n          year: 'numeric',\n          month: '2-digit', \n          day: '2-digit',\n          hour: '2-digit',\n          minute: '2-digit',\n          second: '2-digit',\n          hour12: false\n        });\n        userCurrentTime = userTimeString;\n        console.log(`${logPrefix} User timezone ${userTimezone} current time: ${userCurrentTime}`);\n      } catch (timezoneError) {\n        console.warn(`${logPrefix} Invalid timezone ${userTimezone}, using UTC:`, timezoneError);\n        userCurrentTime = currentDate.toISOString();\n      }\n    } else {\n      userCurrentTime = currentDate.toISOString();\n    }\n    \n    const currentWeekStart = new Date(currentDate);\n    currentWeekStart.setDate(currentDate.getDate() - currentDate.getDay()); // Start of week (Sunday)\n    currentWeekStart.setHours(0, 0, 0, 0);\n    \n    const currentWeekEnd = new Date(currentWeekStart);\n    currentWeekEnd.setDate(currentWeekStart.getDate() + 6); // End of week (Saturday)\n    currentWeekEnd.setHours(23, 59, 59, 999);\n\n    console.log(`${logPrefix} CURRENT DATE CONTEXT: today=${currentDate.toISOString()}, weekStart=${currentWeekStart.toISOString()}, weekEnd=${currentWeekEnd.toISOString()}, userTime=${userCurrentTime}`);\n\n    const systemMessage: OpenAI.Chat.Completions.ChatCompletionMessageParam = {\n      role: \"system\",\n      content: SYSTEM_PROMPT + `\n\nCURRENT DATE CONTEXT:\n- Today's date: ${currentDate.toISOString().split('T')[0]}\n- Current time (UTC): ${currentDate.toISOString()}\n- Current time (User timezone): ${userCurrentTime}\n- This week starts: ${currentWeekStart.toISOString().split('T')[0]} (Sunday)\n- This week ends: ${currentWeekEnd.toISOString().split('T')[0]} (Saturday)\n- User timezone: ${userTimezone || 'UTC'}\n- User ID: ${userId}\n\nCRITICAL EVENT CREATION RULES:\n🚨 **NEVER CREATE EVENTS IN THE PAST** 🚨\n- ALWAYS check if the requested time has already passed in the user's timezone\n- If user says \"8 AM\" and it's currently 3:37 PM, they mean 8 AM TOMORROW\n- If user says \"2 PM\" and it's currently 1 PM, they mean 2 PM TODAY\n- If user says \"10 AM\" and it's currently 11 AM, they mean 10 AM TOMORROW\n- When in doubt, ask for clarification: \"Do you mean 8 AM today or tomorrow?\"\n\nTIMEZONE HANDLING:\n- User timezone is: ${userTimezone || 'UTC'}\n- Current time in user timezone: ${userCurrentTime}\n- When creating events, consider the user's local time context\n- If no date is specified, use the next occurrence of that time\n\nIMPORTANT DATE CALCULATION RULES:\n- When user says \"this week\", use start_date: \"${currentWeekStart.toISOString()}\" and end_date: \"${currentWeekEnd.toISOString()}\"\n- When user says \"today\", use start_date and end_date for the current day\n- When user says \"tomorrow\", calculate the next day's date range\n- Always use ISO format for dates: YYYY-MM-DDTHH:mm:ss.sssZ\n- VALIDATE: All event times must be in the future relative to user's current time\n\nEXAMPLE FOR \"THIS WEEK\" QUERY:\nUser: \"Show events for this week\"\nCorrect tool call: {\n  \"operation_type\": \"calendar\",\n  \"action\": \"search\", \n  \"search_criteria\": {\n    \"start_date\": \"${currentWeekStart.toISOString()}\",\n    \"end_date\": \"${currentWeekEnd.toISOString()}\"\n  }\n}`\n    };\n\n    // Always use manual conversation state management for reliability\n    // The frontend already sends the full conversation history, so we use that\n    console.log(`${logPrefix} Using manual conversation state management with ${messages.length} messages`);\n    \n    const conversationMessages = [systemMessage, ...messages];\n\n    // Make OpenAI call with conversation state management\n    const completion = await openai.chat.completions.create({\n      model: process.env.OPENAI_MODEL || \"gpt-4o\",\n      messages: conversationMessages,\n      tools: [universalTool],\n      tool_choice: \"auto\",\n      temperature: 0.1,\n      store: true // Enable conversation state persistence\n    });\n\n    const assistantMessage = completion.choices[0]?.message;\n    if (!assistantMessage) {\n      throw new Error(\"No response from OpenAI\");\n    }\n\n    // Handle tool calls if present\n    if (assistantMessage.tool_calls) {\n      console.log(`${logPrefix} Processing ${assistantMessage.tool_calls.length} tool calls`);\n      console.log(`${logPrefix} Tool calls details:`, JSON.stringify(assistantMessage.tool_calls, null, 2));\n      \n      const toolResults = [];\n      \n      for (const toolCall of assistantMessage.tool_calls) {\n        console.log(`${logPrefix} Executing tool: ${toolCall.function.name}`);\n        console.log(`${logPrefix} Tool arguments:`, toolCall.function.arguments);\n        \n        const args = JSON.parse(toolCall.function.arguments) as UniversalOperationArgs;\n        console.log(`${logPrefix} Parsed args:`, JSON.stringify(args, null, 2));\n        \n        // CRITICAL: Validate and fix date issues\n        if (args.operation_type === 'calendar') {\n          const currentDate = new Date();\n          \n          // CRITICAL: Validate event creation times to prevent past events\n          if (args.action === 'create' && args.entity_data) {\n            const startTime = args.entity_data.start_time as string;\n            if (startTime) {\n              const eventStartTime = new Date(startTime);\n              console.log(`${logPrefix} VALIDATING EVENT TIME: ${startTime} (${eventStartTime.toISOString()}) vs current ${currentDate.toISOString()}`);\n              \n              // Check if event is in the past (with 1 minute buffer for processing time)\n              const oneMinuteAgo = new Date(currentDate.getTime() - 60000);\n              if (eventStartTime < oneMinuteAgo) {\n                console.error(`${logPrefix} 🚨 BLOCKING PAST EVENT CREATION: Event time ${eventStartTime.toISOString()} is before current time ${currentDate.toISOString()}`);\n                \n                // Return error immediately - don't create past events\n                toolResults.push({\n                  tool_call_id: toolCall.id,\n                  role: \"tool\" as const,\n                  content: JSON.stringify({\n                    success: false,\n                    error: `Cannot create event in the past. The requested time ${eventStartTime.toLocaleString()} has already passed. Current time is ${currentDate.toLocaleString()}. Did you mean to schedule this for tomorrow or a future date?`\n                  })\n                });\n                continue; // Skip this tool call\n              }\n            }\n          }\n          \n          // Handle search criteria date validation\n          if (args.search_criteria) {\n            // Check for old dates and fix them\n            if (args.search_criteria.start_date) {\n              const startDate = new Date(args.search_criteria.start_date as string);\n              if (startDate.getFullYear() < 2024) {\n                console.warn(`${logPrefix} FIXING OLD START DATE: ${args.search_criteria.start_date} -> using current week`);\n                const currentWeekStart = new Date(currentDate);\n                currentWeekStart.setDate(currentDate.getDate() - currentDate.getDay());\n                currentWeekStart.setHours(0, 0, 0, 0);\n                args.search_criteria.start_date = currentWeekStart.toISOString();\n              }\n            }\n            \n            if (args.search_criteria.end_date) {\n              const endDate = new Date(args.search_criteria.end_date as string);\n              if (endDate.getFullYear() < 2024) {\n                console.warn(`${logPrefix} FIXING OLD END DATE: ${args.search_criteria.end_date} -> using current week`);\n                const currentWeekStart = new Date(currentDate);\n                currentWeekStart.setDate(currentDate.getDate() - currentDate.getDay());\n                const currentWeekEnd = new Date(currentWeekStart);\n                currentWeekEnd.setDate(currentWeekStart.getDate() + 6);\n                currentWeekEnd.setHours(23, 59, 59, 999);\n                args.search_criteria.end_date = currentWeekEnd.toISOString();\n              }\n            }\n            \n            // Special handling for \"this week\" requests\n            if (args.user_request && args.user_request.toLowerCase().includes('this week')) {\n              console.log(`${logPrefix} DETECTED \"this week\" request - ensuring correct dates`);\n              const currentWeekStart = new Date(currentDate);\n              currentWeekStart.setDate(currentDate.getDate() - currentDate.getDay());\n              currentWeekStart.setHours(0, 0, 0, 0);\n              \n              const currentWeekEnd = new Date(currentWeekStart);\n              currentWeekEnd.setDate(currentWeekStart.getDate() + 6);\n              currentWeekEnd.setHours(23, 59, 59, 999);\n              \n              args.search_criteria.start_date = currentWeekStart.toISOString();\n              args.search_criteria.end_date = currentWeekEnd.toISOString();\n              \n              console.log(`${logPrefix} CORRECTED DATES: start=${args.search_criteria.start_date}, end=${args.search_criteria.end_date}`);\n            }\n          }\n        }\n        \n        try {\n          const result = await executeUniversalOperation(args, userId, event, logPrefix, userTimezone);\n          console.log(`${logPrefix} Tool result:`, JSON.stringify(result, null, 2));\n          \n          toolResults.push({\n            tool_call_id: toolCall.id,\n            role: \"tool\" as const,\n            content: JSON.stringify(result)\n          });\n        } catch (error) {\n          console.error(`${logPrefix} Tool execution error:`, error);\n          toolResults.push({\n            tool_call_id: toolCall.id,\n            role: \"tool\" as const,\n            content: JSON.stringify({\n              success: false,\n              error: error instanceof Error ? error.message : 'Unknown error'\n            })\n          });\n        }\n      }\n\n      // Get final response with tool results\n      const finalMessages = [\n        ...conversationMessages,\n        assistantMessage,\n        ...toolResults\n      ];\n\n      const finalCompletion = await openai.chat.completions.create({\n        model: process.env.OPENAI_MODEL || \"gpt-4o\",\n        messages: finalMessages,\n        temperature: 0.1,\n        store: true\n      });\n\n      const finalResponse = finalCompletion.choices[0]?.message;\n      if (!finalResponse) {\n        throw new Error(\"No final response from OpenAI\");\n      }\n\n      // Update conversation state with the final response ID\n      if (finalCompletion.id) {\n        updateConversationState(userId, finalCompletion.id);\n        console.log(`${logPrefix} Updated conversation state with response ID: ${finalCompletion.id}`);\n      }\n\n      console.log(`${logPrefix} Completed successfully with tool execution`);\n      \n      // Check if any tool results indicate we should refresh calendar or contacts\n      let shouldRefreshCalendar = false;\n      let shouldRefreshContacts = false;\n      \n      for (const toolResult of toolResults) {\n        try {\n          const resultData = JSON.parse(toolResult.content);\n          if (resultData.triggerRefresh) {\n            // Determine what to refresh based on the operation type\n            const toolCall = assistantMessage.tool_calls?.find(tc => tc.id === toolResult.tool_call_id);\n            if (toolCall) {\n              const args = JSON.parse(toolCall.function.arguments) as UniversalOperationArgs;\n              if (args.operation_type === 'calendar') {\n                shouldRefreshCalendar = true;\n                console.log(`${logPrefix} Calendar operation with triggerRefresh detected - will refresh calendar`);\n              } else if (args.operation_type === 'contact') {\n                shouldRefreshContacts = true;\n                console.log(`${logPrefix} Contact operation with triggerRefresh detected - will refresh contacts`);\n              }\n            }\n          }\n        } catch (parseError) {\n          // Ignore parse errors for tool results\n        }\n      }\n      \n      return {\n        statusCode: 200,\n        headers,\n        body: JSON.stringify({\n          role: 'assistant',\n          content: finalResponse.content || '',\n          _metadata: {\n            usage: finalCompletion.usage,\n            tool_calls_made: assistantMessage.tool_calls.length,\n            response_id: finalCompletion.id,\n            should_refresh_calendar: shouldRefreshCalendar,\n            should_refresh_contacts: shouldRefreshContacts\n          }\n        })\n      };\n    }\n\n    // No tool calls, return direct response\n    // Update conversation state with the response ID\n    if (completion.id) {\n      updateConversationState(userId, completion.id);\n      console.log(`${logPrefix} Updated conversation state with response ID: ${completion.id}`);\n    }\n\n    console.log(`${logPrefix} Completed successfully without tool calls`);\n    return {\n      statusCode: 200,\n      headers,\n      body: JSON.stringify({\n        role: 'assistant',\n        content: assistantMessage.content || '',\n        _metadata: {\n          usage: completion.usage,\n          response_id: completion.id\n        }\n      })\n    };\n\n  } catch (error) {\n    console.error(`${logPrefix} Error:`, error);\n    return {\n      statusCode: 500,\n      headers: {\n        \"Content-Type\": \"application/json\",\n        \"Access-Control-Allow-Origin\": \"*\"\n      },\n      body: JSON.stringify({\n        error: \"Internal server error\",\n        message: error instanceof Error ? error.message : 'Unknown error'\n      })\n    };\n  }\n};\n\n// Universal operation executor\nasync function executeUniversalOperation(\n  args: UniversalOperationArgs,\n  userId: string,\n  event: HandlerEvent,\n  logPrefix: string,\n  _userTimezone?: string\n): Promise<Record<string, unknown>> {\n  const { operation_type, action, entity_data, search_criteria } = args;\n  \n  console.log(`${logPrefix} ========== EXECUTING OPERATION ==========`);\n  console.log(`${logPrefix} Operation Type: ${operation_type}`);\n  console.log(`${logPrefix} Action: ${action}`);\n  console.log(`${logPrefix} Entity Data:`, JSON.stringify(entity_data, null, 2));\n  console.log(`${logPrefix} Search Criteria:`, JSON.stringify(search_criteria, null, 2));\n  console.log(`${logPrefix} User ID: ${userId}`);\n  console.log(`${logPrefix} ==========================================`);\n\n  switch (operation_type) {\n    case 'contact':\n      return await executeContactOperation(action, entity_data, search_criteria, userId, logPrefix);\n    \n    case 'calendar':\n      return await executeCalendarOperation(action, entity_data, search_criteria, userId, event, logPrefix);\n    \n    case 'alert':\n      return await executeAlertOperation(action, entity_data, search_criteria, userId, logPrefix);\n    \n    case 'settings':\n      return await executeSettingsOperation(action, entity_data, userId, event, logPrefix);\n    \n    case 'duplicate_management':\n      return await executeDuplicateManagementOperation(action, entity_data, search_criteria, userId, logPrefix);\n    \n    case 'general':\n      return {\n        success: true,\n        message: \"I can help you with contact management, calendar events, alerts, and settings. What would you like to do?\"\n      };\n    \n    default:\n      return {\n        success: false,\n        error: `Unknown operation type: ${operation_type}`\n      };\n  }\n}\n\n// Contact operations\nasync function executeContactOperation(\n  action: string,\n  entity_data: Record<string, unknown> | null,\n  search_criteria: Record<string, unknown> | null,\n  userId: string,\n  logPrefix: string\n): Promise<Record<string, unknown>> {\n  try {\n    switch (action) {\n      case 'create': {\n        if (!entity_data) {\n          return { success: false, error: \"Entity data required for contact creation\" };\n        }\n        \n        // Filter to only contact-specific fields\n        const contactFields = {\n          first_name: entity_data.first_name,\n          last_name: entity_data.last_name,\n          middle_name: entity_data.middle_name,\n          nickname: entity_data.nickname,\n          email: entity_data.email,\n          phone: entity_data.phone,\n          mobile_phone: entity_data.mobile_phone,\n          work_phone: entity_data.work_phone,\n          company: entity_data.company,\n          job_title: entity_data.job_title,\n          department: entity_data.department,\n          address: entity_data.address,\n          street_address: entity_data.street_address,\n          street_address_2: entity_data.street_address_2,\n          city: entity_data.city,\n          state_province: entity_data.state_province,\n          postal_code: entity_data.postal_code,\n          country: entity_data.country,\n          formatted_address: entity_data.formatted_address,\n          website: entity_data.website,\n          birthday: entity_data.birthday,\n          notes: entity_data.notes,\n          tags: entity_data.tags,\n          social_linkedin: entity_data.social_linkedin,\n          social_twitter: entity_data.social_twitter,\n          preferred_contact_method: entity_data.preferred_contact_method,\n          language: entity_data.language,\n          google_contact_id: entity_data.google_contact_id,\n          import_source: entity_data.import_source,\n          import_batch_id: entity_data.import_batch_id\n        };\n        \n        // Remove null/undefined fields\n        const filteredData = Object.fromEntries(\n          Object.entries(contactFields).filter(([_, value]) => value !== null && value !== undefined)\n        );\n        \n        const { data, error } = await supabaseAdmin\n          .from('contacts')\n          .insert({ ...filteredData, user_id: userId })\n          .select()\n          .single();\n        \n        if (error) throw error;\n        \n        // Clear search cache for this user to ensure fresh data in search results\n        try {\n          const { clearUserCache } = await import('./contacts-search');\n          clearUserCache(userId);\n          console.log(`${logPrefix} Cleared search cache for user after contact creation`);\n        } catch (cacheError) {\n          console.warn(`${logPrefix} Failed to clear search cache:`, cacheError);\n          // Don't fail the creation if cache clearing fails\n        }\n        \n        return { success: true, operation: 'create', contact: data };\n      }\n      \n      case 'search':\n      case 'list': {\n        console.log(`${logPrefix} ========== CONTACT SEARCH/LIST ==========`);\n        console.log(`${logPrefix} Action: ${action}`);\n        console.log(`${logPrefix} Search criteria:`, JSON.stringify(search_criteria, null, 2));\n        \n        let query = supabaseAdmin\n          .from('contacts')\n          .select('*')\n          .eq('user_id', userId);\n        \n        if (search_criteria) {\n          // Handle different types of search criteria\n          if ('search_term' in search_criteria && search_criteria.search_term) {\n            const searchTerm = search_criteria.search_term as string;\n            console.log(`${logPrefix} Contact search for term: \"${searchTerm}\"`);\n            \n            // Special handling for specific search types\n            if (searchTerm.toLowerCase().includes('duplicate')) {\n              console.log(`${logPrefix} Detected duplicate search`);\n              // Handle duplicate detection\n              // This would need a more sophisticated duplicate detection algorithm\n              // For now, find contacts with similar names or emails\n              query = query.or(`first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);\n            } else if (searchTerm.toLowerCase().includes('manager') || searchTerm.toLowerCase().includes('director') || searchTerm.toLowerCase().includes('ceo')) {\n              console.log(`${logPrefix} Detected job title search`);\n              // Handle job title searches\n              query = query.ilike('job_title', `%${searchTerm}%`);\n            } else {\n              console.log(`${logPrefix} General search detected`);\n              // General search across all fields\n              const searchTerm = search_criteria.search_term as string;\n              \n              // Check if this might be a full name search (contains space)\n              if (searchTerm.includes(' ')) {\n                console.log(`${logPrefix} Full name search detected`);\n                // Split the name and search for combinations\n                const parts = searchTerm.split(' ').filter(p => p.length > 0);\n                console.log(`${logPrefix} Name parts:`, parts);\n                \n                if (parts.length === 2) {\n                  // Likely first and last name\n                  const [first, last] = parts;\n                  console.log(`${logPrefix} Searching for first: \"${first}\", last: \"${last}\"`);\n                  // Search for exact first AND last name match, or the full search term in other fields\n                  query = query.or(\n                    `and(first_name.ilike.%${first}%,last_name.ilike.%${last}%),` +\n                    `and(first_name.ilike.%${last}%,last_name.ilike.%${first}%),` +\n                    `email.ilike.%${searchTerm}%,` +\n                    `company.ilike.%${searchTerm}%,` +\n                    `notes.ilike.%${searchTerm}%`\n                  );\n                } else {\n                  console.log(`${logPrefix} Multiple parts search`);\n                  // Multiple parts or single part with space - search as is\n                  query = query.or(`first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%,company.ilike.%${searchTerm}%,job_title.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%,notes.ilike.%${searchTerm}%`);\n                }\n              } else {\n                console.log(`${logPrefix} Single word search`);\n                // Single word search - search across all fields\n                query = query.or(`first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%,company.ilike.%${searchTerm}%,job_title.ilike.%${searchTerm}%,phone.ilike.%${searchTerm}%`);\n              }\n            }\n          }\n          \n          // Handle birthday searches\n          if ('upcoming' in search_criteria && search_criteria.upcoming) {\n            console.log(`${logPrefix} Birthday search detected`);\n            const today = new Date();\n            const futureDate = new Date();\n            futureDate.setDate(today.getDate() + 30); // Next 30 days\n            \n            // Birthday field is stored as MM-DD, so we need to handle year-agnostic searches\n            const todayMD = String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');\n            const futureMD = String(futureDate.getMonth() + 1).padStart(2, '0') + '-' + String(futureDate.getDate()).padStart(2, '0');\n            \n            if (today.getMonth() === futureDate.getMonth()) {\n              // Same month\n              query = query.gte('birthday', todayMD).lte('birthday', futureMD);\n            } else {\n              // Cross month boundary\n              query = query.or(`birthday.gte.${todayMD},birthday.lte.${futureMD}`);\n            }\n          }\n          \n          // Handle company searches\n          if ('company' in search_criteria && search_criteria.company) {\n            console.log(`${logPrefix} Company search detected`);\n            query = query.ilike('company', `%${search_criteria.company}%`);\n          }\n          \n          // Handle specific contact ID\n          if ('contact_id' in search_criteria && search_criteria.contact_id) {\n            console.log(`${logPrefix} Contact ID search detected`);\n            query = query.eq('contact_id', search_criteria.contact_id);\n          }\n        }\n        \n        console.log(`${logPrefix} Executing contact query...`);\n        const { data, error } = await query.order('first_name', { ascending: true }).limit(10);\n        \n        console.log(`${logPrefix} Query result:`, { error, dataLength: data?.length });\n        if (error) {\n          console.error(`${logPrefix} Query error:`, error);\n          throw error;\n        }\n        \n        console.log(`${logPrefix} Contact search found ${data?.length || 0} results`);\n        if (data && data.length > 0) {\n          console.log(`${logPrefix} First few results:`, data.slice(0, 3).map(c => `${c.first_name} ${c.last_name} (${c.contact_id})`));\n        }\n        console.log(`${logPrefix} ========== CONTACT SEARCH COMPLETE ==========`);\n        \n        return { success: true, operation: action, contacts: data, total: data.length };\n      }\n      \n      case 'update': {\n        if (!entity_data || Object.keys(entity_data).length === 0) {\n          return { success: false, error: \"No data provided for update\" };\n        }\n        \n        // Handle both contact_id and search_term approaches\n        let contactToUpdate = null;\n        \n        if (search_criteria && 'contact_id' in search_criteria && search_criteria.contact_id) {\n          // Direct contact ID approach\n          const { data: contact, error: findError } = await supabaseAdmin\n            .from('contacts')\n            .select('*')\n            .eq('contact_id', search_criteria.contact_id)\n            .eq('user_id', userId)\n            .single();\n          \n          if (findError || !contact) {\n            return { success: false, error: `Contact with ID ${search_criteria.contact_id} not found` };\n          }\n          contactToUpdate = contact;\n          \n        } else if (search_criteria && 'search_term' in search_criteria && search_criteria.search_term) {\n          // Search by name approach\n          const searchTerm = search_criteria.search_term as string;\n          console.log(`${logPrefix} Update: Searching for contact: \"${searchTerm}\"`);\n          \n          let query = supabaseAdmin\n            .from('contacts')\n            .select('*')\n            .eq('user_id', userId);\n          \n          // Use same search logic as the search action\n          if (searchTerm.includes(' ')) {\n            const parts = searchTerm.split(' ').filter(p => p.length > 0);\n            if (parts.length === 2) {\n              const [first, last] = parts;\n              query = query.or(\n                `and(first_name.ilike.%${first}%,last_name.ilike.%${last}%),` +\n                `and(first_name.ilike.%${last}%,last_name.ilike.%${first}%)`\n              );\n            } else {\n              query = query.or(`first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%`);\n            }\n          } else {\n            query = query.or(`first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);\n          }\n          \n          const { data: contacts, error: searchError } = await query.limit(10);\n          \n          if (searchError) {\n            console.error(`${logPrefix} Update search error:`, searchError);\n            throw searchError;\n          }\n          \n          if (!contacts || contacts.length === 0) {\n            return { success: false, error: `No contacts found matching \"${searchTerm}\"` };\n          }\n          \n          if (contacts.length > 1) {\n            return { \n              success: false, \n              error: `Multiple contacts found matching \"${searchTerm}\". Please be more specific.`,\n              contacts: contacts.map(c => ({ \n                contact_id: c.contact_id, \n                name: `${c.first_name} ${c.last_name}`, \n                email: c.email \n              }))\n            };\n          }\n          \n          contactToUpdate = contacts[0];\n          console.log(`${logPrefix} Found contact to update: ${contactToUpdate.first_name} ${contactToUpdate.last_name} (${contactToUpdate.contact_id})`);\n          \n        } else {\n          return { success: false, error: \"Either contact_id or search_term required for update\" };\n        }\n        \n        // Filter to only contact-specific fields that are being updated\n        const contactFields = {\n          first_name: entity_data.first_name,\n          last_name: entity_data.last_name,\n          middle_name: entity_data.middle_name,\n          nickname: entity_data.nickname,\n          email: entity_data.email,\n          phone: entity_data.phone,\n          mobile_phone: entity_data.mobile_phone,\n          work_phone: entity_data.work_phone,\n          company: entity_data.company,\n          job_title: entity_data.job_title,\n          department: entity_data.department,\n          address: entity_data.address,\n          street_address: entity_data.street_address,\n          street_address_2: entity_data.street_address_2,\n          city: entity_data.city,\n          state_province: entity_data.state_province,\n          postal_code: entity_data.postal_code,\n          country: entity_data.country,\n          formatted_address: entity_data.formatted_address,\n          website: entity_data.website,\n          birthday: entity_data.birthday,\n          notes: entity_data.notes,\n          tags: entity_data.tags,\n          social_linkedin: entity_data.social_linkedin,\n          social_twitter: entity_data.social_twitter,\n          preferred_contact_method: entity_data.preferred_contact_method,\n          language: entity_data.language,\n          google_contact_id: entity_data.google_contact_id,\n          import_source: entity_data.import_source,\n          import_batch_id: entity_data.import_batch_id\n        };\n        \n        // Remove null/undefined fields - only update fields that are explicitly provided\n        const filteredData = Object.fromEntries(\n          Object.entries(contactFields).filter(([_, value]) => value !== null && value !== undefined)\n        );\n        \n        console.log(`${logPrefix} Updating contact ${contactToUpdate.contact_id} with:`, filteredData);\n        \n        const { data, error } = await supabaseAdmin\n          .from('contacts')\n          .update(filteredData)\n          .eq('contact_id', contactToUpdate.contact_id)\n          .eq('user_id', userId)\n          .select()\n          .single();\n        \n        if (error) {\n          console.error(`${logPrefix} Update error:`, error);\n          throw error;\n        }\n        \n        console.log(`${logPrefix} Contact updated successfully`);\n        \n        // Clear search cache for this user to ensure fresh data in search results\n        try {\n          const { clearUserCache } = await import('./contacts-search');\n          clearUserCache(userId);\n          console.log(`${logPrefix} Cleared search cache for user after contact update`);\n        } catch (cacheError) {\n          console.warn(`${logPrefix} Failed to clear search cache:`, cacheError);\n          // Don't fail the update if cache clearing fails\n        }\n        \n        return { \n          success: true, \n          operation: 'update', \n          contact: data,\n          message: `Successfully updated ${data.first_name} ${data.last_name}`\n        };\n      }\n      \n      case 'delete': {\n        if (!search_criteria || !('contact_id' in search_criteria)) {\n          return { success: false, error: \"Contact ID required for delete\" };\n        }\n        \n        const contactId = search_criteria.contact_id;\n        \n        // Validate that contact_id is a valid UUID\n        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n        if (typeof contactId !== 'string' || !uuidRegex.test(contactId)) {\n          return { \n            success: false, \n            error: `Invalid contact ID format. Expected a UUID but got: ${contactId}. Please use the contact_id from the search results, not an email or other field.` \n          };\n        }\n        \n        const { error } = await supabaseAdmin\n          .from('contacts')\n          .delete()\n          .eq('contact_id', contactId)\n          .eq('user_id', userId);\n        \n        if (error) throw error;\n        \n        // Clear search cache for this user to ensure fresh data in search results\n        try {\n          const { clearUserCache } = await import('./contacts-search');\n          clearUserCache(userId);\n          console.log(`${logPrefix} Cleared search cache for user after contact deletion`);\n        } catch (cacheError) {\n          console.warn(`${logPrefix} Failed to clear search cache:`, cacheError);\n          // Don't fail the deletion if cache clearing fails\n        }\n        \n        return { success: true, operation: 'delete', message: \"Contact deleted successfully\" };\n      }\n      \n      default:\n        return { success: false, error: `Unknown contact action: ${action}` };\n    }\n  } catch (error) {\n    console.error(`${logPrefix} Contact operation error:`, error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Contact operation failed'\n    };\n  }\n}\n\n// Calendar operations\nasync function executeCalendarOperation(\n  action: string,\n  entity_data: Record<string, unknown> | null,\n  search_criteria: Record<string, unknown> | null,\n  userId: string,\n  event: HandlerEvent,\n  logPrefix: string\n): Promise<Record<string, unknown>> {\n  try {\n    const baseUrl = process.env.URL || '';\n    const authHeader = event.headers.authorization || '';\n    \n    if (action === 'create' && entity_data) {\n      // For CREATE: POST request with event data directly in body\n      const eventPayload = {\n        title: entity_data.title,\n        start_time: entity_data.start_time,\n        end_time: entity_data.end_time,\n        description: entity_data.description || '',\n        location: entity_data.location || '',\n        is_all_day: entity_data.is_all_day || false,\n        is_recurring: entity_data.is_recurring || false,\n        recurrence_pattern: entity_data.recurrence_pattern || null\n      };\n\n      const response = await fetch(`${baseUrl}/.netlify/functions/calendar`, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': authHeader\n        },\n        body: JSON.stringify(eventPayload)\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`${logPrefix} Calendar CREATE error: ${response.status} - ${errorText}`);\n        throw new Error(`Calendar CREATE error: ${response.status} - ${errorText}`);\n      }\n\n      const result = await response.json();\n      return { success: true, operation: 'create', event: result, triggerRefresh: true };\n      \n    } else if (action === 'search' || action === 'list') {\n      // For SEARCH/LIST: GET request with query parameters\n      const queryParams = new URLSearchParams();\n      \n      if (search_criteria) {\n        if (search_criteria.search_term) {\n          queryParams.append('search_term', search_criteria.search_term as string);\n        }\n        if (search_criteria.start_date) {\n          queryParams.append('start_date', search_criteria.start_date as string);\n        }\n        if (search_criteria.end_date) {\n          queryParams.append('end_date', search_criteria.end_date as string);\n        }\n        if (search_criteria.upcoming) {\n          // Convert \"upcoming\" to a date range\n          const now = new Date();\n          const future = new Date();\n          future.setDate(now.getDate() + 30); // Next 30 days\n          queryParams.append('start_date', now.toISOString());\n          queryParams.append('end_date', future.toISOString());\n        }\n      }\n\n      const url = `${baseUrl}/.netlify/functions/calendar${queryParams.toString() ? '?' + queryParams.toString() : ''}`;\n      \n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'Authorization': authHeader\n        }\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`${logPrefix} Calendar ${action.toUpperCase()} error: ${response.status} - ${errorText}`);\n        throw new Error(`Calendar ${action.toUpperCase()} error: ${response.status} - ${errorText}`);\n      }\n\n      const result = await response.json();\n      return { success: true, operation: action, events: result, total: result.length };\n      \n    } else if (action === 'update' && entity_data) {\n      // For UPDATE: PUT request with event data in body and ID in path\n      // Event ID can be in search_criteria or entity_data\n      let eventId: string | null = null;\n      \n      if (search_criteria && search_criteria.event_id) {\n        eventId = search_criteria.event_id as string;\n      } else if (entity_data.event_id) {\n        eventId = entity_data.event_id as string;\n      }\n      \n      if (!eventId) {\n        return {\n          success: false,\n          error: \"Event ID is required for calendar update. Please provide the event_id in search_criteria or specify which event to update.\"\n        };\n      }\n      \n      // Validate that the event ID looks like a proper UUID\n      const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n      if (!uuidRegex.test(eventId)) {\n        console.error(`${logPrefix} Invalid event ID format: \"${eventId}\" - this looks like it might be a Zoom meeting ID or other identifier, not an event_id`);\n        return {\n          success: false,\n          error: `Invalid event ID format: \"${eventId}\". This appears to be a Zoom meeting ID or other identifier, not a proper event_id. Please use the event_id from the previous search results (e.g., \"7aa85146-3eb7-4bea-9d07-59325ff7e063\").`\n        };\n      }\n      \n      console.log(`${logPrefix} Using event ID for update: ${eventId}`);\n      \n      const updatePayload = {\n        title: entity_data.title,\n        start_time: entity_data.start_time,\n        end_time: entity_data.end_time,\n        description: entity_data.description,\n        location: entity_data.location,\n        is_all_day: entity_data.is_all_day,\n        is_recurring: entity_data.is_recurring,\n        recurrence_pattern: entity_data.recurrence_pattern\n      };\n      \n      // Remove null/undefined fields\n      const filteredPayload = Object.fromEntries(\n        Object.entries(updatePayload).filter(([_, value]) => value !== null && value !== undefined)\n      );\n\n      const response = await fetch(`${baseUrl}/.netlify/functions/calendar/${eventId}`, {\n        method: 'PUT',\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': authHeader\n        },\n        body: JSON.stringify(filteredPayload)\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`${logPrefix} Calendar UPDATE error: ${response.status} - ${errorText}`);\n        throw new Error(`Calendar UPDATE error: ${response.status} - ${errorText}`);\n      }\n\n      const result = await response.json();\n      return { success: true, operation: 'update', event: result, triggerRefresh: true };\n      \n    } else if (action === 'delete') {\n      // For DELETE: We need an event ID, but if only search_criteria with search_term is provided,\n      // we should first find the event, then delete it\n      \n      if (search_criteria && search_criteria.event_id) {\n        // Direct deletion with event ID\n        const eventId = search_criteria.event_id as string;\n\n        const response = await fetch(`${baseUrl}/.netlify/functions/calendar/${eventId}`, {\n          method: 'DELETE',\n          headers: {\n            'Authorization': authHeader\n          }\n        });\n\n        if (!response.ok) {\n          const errorText = await response.text();\n          console.error(`${logPrefix} Calendar DELETE error: ${response.status} - ${errorText}`);\n          throw new Error(`Calendar DELETE error: ${response.status} - ${errorText}`);\n        }\n\n        const result = await response.json();\n        return { success: true, operation: 'delete', message: result.message || \"Event deleted successfully\", triggerRefresh: true };\n        \n      } else if (search_criteria && search_criteria.search_term) {\n        // Search for event first, then delete\n        const searchTerm = search_criteria.search_term as string;\n        console.log(`${logPrefix} Searching for event to delete: ${searchTerm}`);\n        \n        // First, search for the event\n        const searchParams = new URLSearchParams();\n        searchParams.append('search_term', searchTerm);\n        \n        const searchResponse = await fetch(`${baseUrl}/.netlify/functions/calendar?${searchParams.toString()}`, {\n          method: 'GET',\n          headers: {\n            'Authorization': authHeader\n          }\n        });\n\n        if (!searchResponse.ok) {\n          const errorText = await searchResponse.text();\n          console.error(`${logPrefix} Calendar SEARCH error: ${searchResponse.status} - ${errorText}`);\n          throw new Error(`Could not search for event: ${errorText}`);\n        }\n\n        const searchResults = await searchResponse.json();\n        \n        if (!Array.isArray(searchResults) || searchResults.length === 0) {\n          return { \n            success: false, \n            error: `No events found matching \"${searchTerm}\". Please check the event name and try again.` \n          };\n        }\n        \n        if (searchResults.length > 1) {\n          // Multiple events found - return them for user to choose\n          const eventList = searchResults.map((event: { title: string; start_time: string }) => \n            `- ${event.title} (${new Date(event.start_time).toLocaleString()})`\n          ).join('\\n');\n          \n          return { \n            success: false, \n            error: `Multiple events found matching \"${searchTerm}\":\\n${eventList}\\n\\nPlease be more specific or provide the exact date and time.`,\n            events: searchResults\n          };\n        }\n        \n        // Exactly one event found - proceed with deletion\n        const eventToDelete = searchResults[0];\n        console.log(`${logPrefix} Found single event to delete: ${eventToDelete.title} (ID: ${eventToDelete.event_id})`);\n        \n        const deleteResponse = await fetch(`${baseUrl}/.netlify/functions/calendar/${eventToDelete.event_id}`, {\n          method: 'DELETE',\n          headers: {\n            'Authorization': authHeader\n          }\n        });\n\n        if (!deleteResponse.ok) {\n          const errorText = await deleteResponse.text();\n          console.error(`${logPrefix} Calendar DELETE error: ${deleteResponse.status} - ${errorText}`);\n          throw new Error(`Calendar DELETE error: ${errorText}`);\n        }\n\n        await deleteResponse.json(); // Parse response but don't store in unused variable\n        return { \n          success: true, \n          operation: 'delete', \n          message: `Successfully deleted \"${eventToDelete.title}\" scheduled for ${new Date(eventToDelete.start_time).toLocaleString()}`,\n          deleted_event: eventToDelete,\n          triggerRefresh: true\n        };\n        \n      } else {\n        return { \n          success: false, \n          error: \"To delete an event, please specify either the event ID or provide the event title/name to search for.\" \n        };\n      }\n      \n    } else {\n      return { \n        success: false, \n        error: `Invalid calendar operation: ${action} with provided data. Missing required fields.` \n      };\n    }\n    \n  } catch (error) {\n    console.error(`${logPrefix} Calendar operation error:`, error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Calendar operation failed'\n    };\n  }\n}\n\n// Alert operations\nasync function executeAlertOperation(\n  action: string,\n  entity_data: Record<string, unknown> | null,\n  search_criteria: Record<string, unknown> | null,\n  userId: string,\n  logPrefix: string\n): Promise<Record<string, unknown>> {\n  try {\n    switch (action) {\n      case 'create': {\n        if (!entity_data) {\n          return { success: false, error: \"Entity data required for alert creation\" };\n        }\n        \n        // Convert priority string to numeric value (OpenAI sends lowercase strings)\n        let priorityValue = entity_data.priority;\n        if (typeof priorityValue === 'string') {\n          const priorityMap: Record<string, number> = {\n            'low': 1,\n            'medium': 2,\n            'high': 3\n          };\n          priorityValue = priorityMap[priorityValue] || 2; // Default to medium if unknown\n        }\n        \n        // Filter to only alert-specific fields\n        const alertFields = {\n          title: entity_data.title,\n          description: entity_data.description,\n          alert_type: entity_data.alert_type,\n          due_date: entity_data.due_date,\n          priority: priorityValue,\n          status: entity_data.status || 'pending',\n          contact_id: entity_data.contact_id,\n          event_id: entity_data.event_id,\n          tags: entity_data.tags\n        };\n        \n        // Remove null/undefined fields\n        const filteredData = Object.fromEntries(\n          Object.entries(alertFields).filter(([_, value]) => value !== null && value !== undefined)\n        );\n        \n        const { data, error } = await supabaseAdmin\n          .from('alerts')\n          .insert({ ...filteredData, user_id: userId })\n          .select()\n          .single();\n        \n        if (error) throw error;\n        return { success: true, operation: 'create', alert: data };\n      }\n      \n      case 'search':\n      case 'list': {\n        let query = supabaseAdmin\n          .from('alerts')\n          .select('*')\n          .eq('user_id', userId);\n        \n        if (search_criteria) {\n          if ('status' in search_criteria) {\n            query = query.eq('status', search_criteria.status);\n          }\n          \n          if ('upcoming' in search_criteria && search_criteria.upcoming) {\n            const now = new Date();\n            const future = new Date();\n            future.setDate(now.getDate() + 30);\n            query = query.gte('due_date', now.toISOString()).lte('due_date', future.toISOString());\n          }\n        }\n        \n        const { data, error } = await query.order('due_date', { ascending: true }).limit(20);\n        if (error) throw error;\n        \n        return { success: true, operation: action, alerts: data, total: data.length };\n      }\n      \n      default:\n        return { success: false, error: `Unknown alert action: ${action}` };\n    }\n  } catch (error) {\n    console.error(`${logPrefix} Alert operation error:`, error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Alert operation failed'\n    };\n  }\n}\n\n// Settings operations\nasync function executeSettingsOperation(\n  action: string,\n  entity_data: Record<string, unknown> | null,\n  userId: string,\n  event: HandlerEvent,\n  logPrefix: string\n): Promise<Record<string, unknown>> {\n  try {\n    // Use the settings API endpoint\n    const endpoint = action === 'read' ? 'get-profile' : 'settings';\n    const response = await fetch(`${process.env.URL}/.netlify/functions/${endpoint}`, {\n      method: action === 'read' ? 'GET' : 'PUT',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': event.headers.authorization || ''\n      },\n      body: action === 'update' ? JSON.stringify({ settings: entity_data }) : undefined\n    });\n\n    if (!response.ok) {\n      throw new Error(`Settings API error: ${response.status}`);\n    }\n\n    const result = await response.json();\n    return { success: true, operation: action, ...result };\n    \n  } catch (error) {\n    console.error(`${logPrefix} Settings operation error:`, error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Settings operation failed'\n    };\n  }\n}\n\n// Duplicate management operations\nasync function executeDuplicateManagementOperation(\n  action: string,\n  _entity_data: Record<string, unknown> | null,\n  search_criteria: Record<string, unknown> | null,\n  userId: string,\n  logPrefix: string\n): Promise<Record<string, unknown>> {\n  console.log(`${logPrefix} ========== DUPLICATE MANAGEMENT ==========`);\n  console.log(`${logPrefix} Action: ${action}`);\n  console.log(`${logPrefix} Search Criteria:`, JSON.stringify(search_criteria, null, 2));\n  console.log(`${logPrefix} User ID: ${userId}`);\n  console.log(`${logPrefix} ==========================================`);\n  \n  try {\n    switch (action) {\n      case 'analyze': {\n        console.log(`${logPrefix} ========== ANALYZE DUPLICATES ==========`);\n        \n        if (!search_criteria || !('search_term' in search_criteria)) {\n          console.log(`${logPrefix} ERROR: No search_term in search_criteria`);\n          return { success: false, error: \"Search term required for duplicate analysis\" };\n        }\n        \n        const searchTerm = search_criteria.search_term as string;\n        console.log(`${logPrefix} Analyzing duplicates for: \"${searchTerm}\"`);\n        \n        // Search for all contacts matching the term\n        let query = supabaseAdmin\n          .from('contacts')\n          .select('*')\n          .eq('user_id', userId);\n        \n        console.log(`${logPrefix} Building query for search term: \"${searchTerm}\"`);\n        \n        // Handle full name searches\n        if (searchTerm.includes(' ')) {\n          console.log(`${logPrefix} Full name search detected in analyze`);\n          const parts = searchTerm.split(' ').filter(p => p.length > 0);\n          console.log(`${logPrefix} Name parts:`, parts);\n          \n          if (parts.length === 2) {\n            const [first, last] = parts;\n            console.log(`${logPrefix} Searching for first: \"${first}\", last: \"${last}\"`);\n            query = query.or(\n              `and(first_name.ilike.%${first}%,last_name.ilike.%${last}%),` +\n              `and(first_name.ilike.%${last}%,last_name.ilike.%${first}%)`\n            );\n          } else {\n            console.log(`${logPrefix} Multiple parts search in analyze`);\n            query = query.or(`first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%`);\n          }\n        } else {\n          console.log(`${logPrefix} Single word search in analyze`);\n          query = query.or(`first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%`);\n        }\n        \n        console.log(`${logPrefix} Executing analyze query...`);\n        const { data: contacts, error } = await query.order('updated_at', { ascending: false }).limit(10);\n        \n        console.log(`${logPrefix} Analyze query result:`, { error, contactsLength: contacts?.length });\n        if (error) {\n          console.error(`${logPrefix} Analyze query error:`, error);\n          throw error;\n        }\n        \n        if (!contacts || contacts.length === 0) {\n          return { \n            success: true, \n            operation: 'analyze',\n            duplicates: [],\n            message: `No contacts found matching \"${searchTerm}\"`\n          };\n        }\n        \n        if (contacts.length === 1) {\n          return { \n            success: true, \n            operation: 'analyze',\n            duplicates: [],\n            message: `Only one contact found matching \"${searchTerm}\" - no duplicates detected`\n          };\n        }\n        \n        // Analyze duplicates - count filled fields for each contact\n        const analyzedContacts = contacts.map(contact => {\n          const importantFields = [\n            'email', 'phone', 'mobile_phone', 'work_phone', \n            'company', 'job_title', 'street_address', 'city',\n            'birthday', 'notes', 'website'\n          ];\n          \n          let filledFieldsCount = 0;\n          const filledFields: string[] = [];\n          \n          for (const field of importantFields) {\n            if (contact[field] && contact[field] !== '') {\n              filledFieldsCount++;\n              filledFields.push(field);\n            }\n          }\n          \n          return {\n            contact_id: contact.contact_id,\n            first_name: contact.first_name,\n            last_name: contact.last_name,\n            email: contact.email,\n            phone: contact.phone,\n            company: contact.company,\n            job_title: contact.job_title,\n            filled_fields_count: filledFieldsCount,\n            filled_fields: filledFields,\n            created_at: contact.created_at,\n            updated_at: contact.updated_at\n          };\n        });\n        \n        // Sort by filled fields count (descending) - most complete first\n        analyzedContacts.sort((a, b) => b.filled_fields_count - a.filled_fields_count);\n        \n        // Identify the most complete\n        const mostComplete = analyzedContacts[0];\n        \n        return {\n          success: true,\n          operation: 'analyze',\n          duplicates: analyzedContacts,\n          total_duplicates: contacts.length,\n          recommendation: {\n            keep: mostComplete,\n            consider_deleting: analyzedContacts.slice(1), // All except the most complete\n            reason: `The contact with ID ${mostComplete.contact_id} has the most complete information (${mostComplete.filled_fields_count} fields filled)`\n          }\n        };\n      }\n      \n      case 'delete': {\n        console.log(`${logPrefix} ========== DELETE DUPLICATE ==========`);\n        \n        // This action would delete a specific duplicate after user confirmation\n        if (!search_criteria || !('contact_id' in search_criteria)) {\n          console.log(`${logPrefix} ERROR: No contact_id in search_criteria`);\n          console.log(`${logPrefix} Search criteria received:`, search_criteria);\n          return { success: false, error: \"Contact ID required for duplicate deletion\" };\n        }\n        \n        const contactId = search_criteria.contact_id;\n        console.log(`${logPrefix} Contact ID to delete: ${contactId}`);\n        console.log(`${logPrefix} Contact ID type: ${typeof contactId}`);\n        \n        // Validate UUID\n        const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n        if (typeof contactId !== 'string' || !uuidRegex.test(contactId)) {\n          console.log(`${logPrefix} ERROR: Invalid UUID format`);\n          return { \n            success: false, \n            error: `Invalid contact ID format. Expected a UUID but got: ${contactId}` \n          };\n        }\n        \n        console.log(`${logPrefix} UUID validation passed`);\n        \n        // First, verify the contact exists and belongs to this user\n        console.log(`${logPrefix} Checking if contact exists...`);\n        const { data: existingContact, error: checkError } = await supabaseAdmin\n          .from('contacts')\n          .select('contact_id, first_name, last_name, email')\n          .eq('contact_id', contactId)\n          .eq('user_id', userId)\n          .single();\n        \n        console.log(`${logPrefix} Check query result:`, { existingContact, checkError });\n        \n        if (checkError || !existingContact) {\n          console.error(`${logPrefix} Contact not found or error checking:`, checkError);\n          return {\n            success: false,\n            error: `Contact with ID ${contactId} not found or you don't have permission to delete it`\n          };\n        }\n        \n        console.log(`${logPrefix} Found contact to delete:`, existingContact);\n        \n        // Delete the duplicate\n        console.log(`${logPrefix} Executing DELETE query...`);\n        const { error, count } = await supabaseAdmin\n          .from('contacts')\n          .delete()\n          .eq('contact_id', contactId)\n          .eq('user_id', userId);\n        \n        console.log(`${logPrefix} Delete query result:`, { error, count });\n        \n        if (error) {\n          console.error(`${logPrefix} Error deleting contact:`, error);\n          throw error;\n        }\n        \n        console.log(`${logPrefix} Delete operation completed. Rows affected: ${count}`);\n        console.log(`${logPrefix} ========== DELETE COMPLETE ==========`);\n        \n        // Clear search cache for this user to ensure fresh data in search results\n        try {\n          const { clearUserCache } = await import('./contacts-search');\n          clearUserCache(userId);\n          console.log(`${logPrefix} Cleared search cache for user after duplicate deletion`);\n        } catch (cacheError) {\n          console.warn(`${logPrefix} Failed to clear search cache:`, cacheError);\n          // Don't fail the deletion if cache clearing fails\n        }\n        \n        return { \n          success: true, \n          operation: 'delete',\n          message: \"Duplicate contact deleted successfully\",\n          deleted_contact_id: contactId,\n          deleted_contact_details: existingContact\n        };\n      }\n      \n      default:\n        return { success: false, error: `Unknown duplicate management action: ${action}` };\n    }\n  } catch (error) {\n    console.error(`${logPrefix} Duplicate management error:`, error);\n    return {\n      success: false,\n      error: error instanceof Error ? error.message : 'Duplicate management operation failed'\n    };\n  }\n}\n\nexport { handler }; "]}